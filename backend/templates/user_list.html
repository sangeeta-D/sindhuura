{% extends 'admin_base.html' %}
{% load static %}
{% block content %}

<!-- CSRF token for JS -->
<form id="csrf-form">{% csrf_token %}</form>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

<div class="content-wrapper">
  <div class="container-xxl flex-grow-1 container-p-y">

    <h4 class="fw-bold mb-4">User List</h4>

    <!-- Filters -->
    <div class="card mb-3">
      <div class="card-body">
        <form method="get" class="row g-3">
          <div class="col-md-3">
            <label class="form-label">Gender</label>
            <select name="gender" class="form-select">
              <option value="">All</option>
              <option value="male">Male</option>
              <option value="female">Female</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">City</label>
            <input type="text" name="city" class="form-control" placeholder="Enter city">
          </div>
          <div class="col-md-3">
            <label class="form-label">State</label>
            <input type="text" name="state" class="form-control" placeholder="Enter state">
          </div>
          <div class="col-md-3">
            <label class="form-label">Premium</label>
            <select name="is_premium" class="form-select">
              <option value="">All</option>
              <option value="1">Premium</option>
              <option value="0">Non-Premium</option>
            </select>
          </div>
          <div class="col-12">
            <button type="submit" class="btn btn-primary">Filter</button>
            <a href="{% url 'user_list' %}" class="btn btn-secondary">Clear</a>
          </div>
        </form>
      </div>
    </div>

    <!-- Search -->
    <div class="row mb-3">
      <div class="col-md-4">
        <input type="text" id="userSearch" class="form-control" placeholder="Search by name, email, phone, city...">
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle" id="userTable">
            <thead class="table-light">
              <tr>
                <th>#</th>
                <th>User</th>
                <th>Phone</th>
                <th>Gender</th>
                <th>Location</th>
                <th>Joined On</th>
                <th>Premium</th>
                <th>Status</th>
                <th class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for user in users %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <!-- User info -->
                <td>
                  <div class="d-flex align-items-center">
                    {% if user.profile_image %}
                      <img src="{{ user.profile_image.url }}" class="rounded-circle me-2" width="40" height="40">
                    {% else %}
                      <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center me-2"
                           style="width:40px;height:40px;">
                        {{ user.email|slice:":1"|upper }}
                      </div>
                    {% endif %}
                    <div>
                      <div class="fw-semibold d-flex align-items-center">
                        {{ user.name|default:"—" }}
                        {% if user.is_verified %}
                          <i class="bx bxs-star text-warning ms-2" style="font-size: 1.2em;"></i>
                        {% endif %}
                      </div>
                      <small class="text-muted">{{ user.email }}</small>
                    </div>
                  </div>
                </td>
                <td>{{ user.phone_number|default:"—" }}</td>
                <td>{% if user.profile %}{{ user.profile.gender|title }}{% else %}—{% endif %}</td>
                <td>{% if user.profile %}{{ user.profile.city }}, {{ user.profile.state }}{% else %}—{% endif %}</td>
                <td>{{ user.date_joined|date:"d M Y" }}</td>
                <td>
                  {% if user.is_premium %}
                    <span class="badge bg-warning">Premium</span>
                  {% else %}
                    <span class="badge bg-secondary">Free</span>
                  {% endif %}
                </td>
                <td>
                  <span class="badge user-status-badge {% if user.is_active %}bg-success{% else %}bg-danger{% endif %}"
                        id="status-badge-{{ user.id }}">
                    {% if user.is_active %}Active{% else %}Inactive{% endif %}
                  </span>
                </td>
                <td class="text-center">
                  <div class="dropdown">
                    <button class="btn btn-sm btn-icon" type="button" data-bs-toggle="dropdown">
                      <i class="bx bx-dots-vertical-rounded"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                      <li>
                        <a class="dropdown-item" href="{% url 'user_details' user.id %}">
                          <i class="bx bx-show me-2"></i> View
                        </a>
                      </li>
                      <li>
                        <a class="dropdown-item" href="{% url 'send_mail' user.id %}">
                          <i class="bx bx-show me-2"></i> Send mail
                        </a>
                      </li>
                      <li>
                        <button class="dropdown-item"
                                onclick="toggleUserActive(event, {{ user.id }}, {{ user.is_active|lower }})">
                          <i class="bx bx-{% if user.is_active %}x{% else %}check{% endif %} me-2"></i>
                          {% if user.is_active %}Deactivate{% else %}Activate{% endif %}
                        </button>
                      </li>
                      <li>
                        <a class="dropdown-item text-danger"
                           href="{% url 'delete_user' user.id %}"
                           onclick="return confirm('Are you sure you want to delete this user?');">
                          <i class="bx bx-trash me-2"></i> Delete
                        </a>
                      </li>
                    </ul>
                  </div>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="9" class="text-center text-muted">No users found</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>

          <br>
          <nav>
            <ul class="pagination justify-content-end" id="pagination"></ul>
          </nav>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
// JS Search + Pagination
const rowsPerPage = 20;
const table = document.getElementById("userTable");
const tbody = table.querySelector("tbody");
let rows = Array.from(tbody.querySelectorAll("tr"));
let filteredRows = [...rows];
let currentPage = 1;

function renderTable() {
  const totalPages = Math.ceil(filteredRows.length / rowsPerPage) || 1;
  filteredRows.forEach((row, index) => {
    row.style.display = index >= (currentPage-1)*rowsPerPage && index < currentPage*rowsPerPage ? "" : "none";
  });

  // Pagination
  const pagination = document.getElementById("pagination");
  pagination.innerHTML = "";
  for(let i=1;i<=totalPages;i++){
    const li = document.createElement("li");
    li.className = "page-item" + (i===currentPage?" active":"");
    li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
    li.onclick = (e)=>{ e.preventDefault(); currentPage=i; renderTable(); };
    pagination.appendChild(li);
  }
}

document.getElementById("userSearch").addEventListener("input", function(){
  const query = this.value.toLowerCase();
  filteredRows = rows.filter(r => r.innerText.toLowerCase().includes(query));
  currentPage = 1;
  renderTable();
});

renderTable();

// Toggle Active / Inactive with Toastify
function toggleUserActive(event, userId, currentStatus) {
  event.preventDefault();
  const newStatus = !currentStatus;
  const actionText = newStatus ? 'activate' : 'deactivate';

  if (!confirm(`Are you sure you want to ${actionText} this user?`)) return;

  const csrfToken = document.querySelector('#csrf-form input[name=csrfmiddlewaretoken]').value;

  fetch(`/users/${userId}/toggle-active/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrfToken
    },
    body: JSON.stringify({ is_active: newStatus })
  })
  .then(res => res.json())
  .then(data => {
    if (!data.status) {
      showToast(data.message || "Something went wrong", false);
      return;
    }

    // Update badge
    const badge = document.getElementById(`status-badge-${userId}`);
    badge.textContent = newStatus ? "Active" : "Inactive";
    badge.classList.toggle("bg-success", newStatus);
    badge.classList.toggle("bg-danger", !newStatus);

    // Update button icon/text
    const btn = event.target.closest("button");
    btn.innerHTML = `<i class="bx bx-${newStatus ? "x":"check"} me-2"></i>${newStatus ? "Deactivate":"Activate"}`;
    btn.setAttribute("onclick", `toggleUserActive(event, ${userId}, ${newStatus})`);

    showToast(`User ${newStatus ? "activated" : "deactivated"} successfully`, true);
  })
  .catch(()=>showToast("Server error occurred", false));
}

function showToast(message, success=true){
  Toastify({
    text: message,
    duration: 3000,
    gravity: "top",
    position: "right",
    close: true,
    backgroundColor: success
      ? "linear-gradient(to right, #00b09b, #96c93d)"
      : "linear-gradient(to right, #ff416c, #ff4b2b)"
  }).showToast();
}
</script>

{% endblock %}
